                                                 ЛАБОРАТОРНА РОБОТА №7
          	                             на тему: «Робота з тригерами в MSSQL.»
                                 
Мета роботи: Ознайомитися з поняттям тригерів у системі керування базами даних Microsoft SQL Server, їхнім призначенням, типами, особливостями використання та впливом на цілісність даних. Навчитися створювати, змінювати та видаляти тригери мовою T-SQL, а також використовувати їх для забезпечення бізнес-правил та обмежень цілісності даних.

                                             Варіант №20 (ДАІ)
База даних повинна містити інформацію про дорожньо-транспортні
подіях (ДТП). Про ДТП має бути відомо вид ДТП, які транспортні засоби в ньому брали участь (можливо більше двох), їх державні номери, П.І.Б., домашні адреси водіїв цих транспортних засобів, а також номери посвідчень водія. Крімтого, необхідно знати кількість постраждалих у даній ДТП, вид травми, П.І.Б., домашня адреса та номер паспорта кожного потерпілого. Постраждалими можуть бути водії. У ДТП можуть брати участь і пішоходи, про які потрібно знати, чи не є вони постраждалими, а також їх П.І.Б., домашню адресу та номер паспорта. Про ДТП також мають бути відомі місце, дата, час, винуватець ДТП та які міліціонери (їх звання та П.І.Б.) виїжджали ДТП.
                          
                                Запити
        •	Вивести повний список ДТП, які виникли з вини пішоходів, за вказаний
        період з повними відомостями про них;
        •	Знайти місце, де сталася максимальна кількість ДТП;
        •	Вивести повний список ДТП, на які ВИЇжджали міліціонери із зазначеним
        званням за вказаний період часу, з повними відомостями про ДТП;
        •	Скласти список водіїв, які брали участь більше НІЖ В ОДНІЙ ДТП за
        зазначений період часу, З повними відомостями про цих водіїв;
        •	Скласти список постраждалих у ДТП за вказаний період часу з
        повними відомостями про ці ДТП, упорядковані за кількістю травм певного виду.
        •	Внести відомості про нову ДТП;
        •	Видалити відомості про ДТП, які сталися раніше вказаної дати.

                            
                        Логічна та фізична модель
![image](https://github.com/user-attachments/assets/f28b2ca6-c263-4cf1-8a6b-23382d8fbcb9)

![image](https://github.com/user-attachments/assets/96d46b57-0b9a-4983-97ca-c6d99bad622c)

Завдання 3. DML тригер AFTER та INSTED OF з використанням різних комбінацій INSERT, UPDATE, DELETE.
У цьому завданні реалізовано чотири DML-тригери в базі даних, які демонструють різні підходи до обробки подій вставки (INSERT), оновлення (UPDATE) та видалення (DELETE) даних у таблицях. Використано два типи тригерів:
•	AFTER-тригери — виконуються після відповідної DML-операції;
•	INSTEAD OF-тригери — замінюють собою стандартне виконання операції, даючи можливість попередньої перевірки та керування логікою змін.
Такі тригери дозволяють реалізувати контроль за правильністю даних, валідацію, аудит змін та запобігання помилкам під час взаємодії з базою даних.

Лістинг коду :

-- Завдання 3: DML тригери (AFTER та INSTEAD OF)

-- AFTER INSERT тригер для таблиці Accident
CREATE TRIGGER tr_Accident_AfterInsert
ON Accident
AFTER INSERT
AS
BEGIN
    PRINT 'AFTER INSERT тригер: Було додано новий запис про ДТП'
    SELECT 'Додано ДТП', i.ID_Accident, i.Date, i.Location 
    FROM inserted i
END;
GO

-- INSTEAD OF INSERT тригер для таблиці Driver
CREATE TRIGGER tr_Driver_InsteadOfInsert
ON Driver
INSTEAD OF INSERT
AS
BEGIN
    PRINT 'INSTEAD OF INSERT тригер: Перевірка даних перед вставкою водія'
    
    -- Перевірка максимальної довжини номеру посвідчення
    IF EXISTS (SELECT 1 FROM inserted WHERE LEN(License_Number) > 10)
    BEGIN
        RAISERROR('Номер посвідчення водія не може бути довшим за 10 символів', 16, 1)
        ROLLBACK TRANSACTION
        RETURN
    END
    
    -- Перевірка максимальної довжини ПІБ
    IF EXISTS (SELECT 1 FROM inserted WHERE LEN(LastName) > 50 OR LEN(FirstName) > 50 OR LEN(MiddleName) > 50)
    BEGIN
        RAISERROR('Кожен компонент ПІБ не може бути довшим за 50 символів', 16, 1)
        ROLLBACK TRANSACTION
        RETURN
    END
    
    -- Якщо все в порядку, виконуємо вставку
    INSERT INTO Driver (LastName, FirstName, MiddleName, Address, License_Number, License_Expiry, Phone)
    SELECT LastName, FirstName, MiddleName, Address, License_Number, License_Expiry, Phone
    FROM inserted
    
    PRINT 'Дані водія успішно додані'
END;
GO

-- AFTER UPDATE тригер для таблиці Vehicle
CREATE TRIGGER tr_Vehicle_AfterUpdate
ON Vehicle
AFTER UPDATE
AS
BEGIN
    PRINT 'AFTER UPDATE тригер: Було оновлено дані транспортного засобу'
    
    SELECT 'Оновлено транспортний засіб', 
           i.ID_Vehicle AS 'ID до', 
           d.ID_Vehicle AS 'ID після',
           d.License_Plate AS 'Новий номер',
           i.License_Plate AS 'Старий номер'
    FROM inserted i
    JOIN deleted d ON i.ID_Vehicle = d.ID_Vehicle
END;
GO

-- INSTEAD OF DELETE тригер для таблиці Policeman
CREATE TRIGGER tr_Policeman_InsteadOfDelete
ON Policeman
INSTEAD OF DELETE
AS
BEGIN
    PRINT 'INSTEAD OF DELETE тригер: Спроба видалення міліціонера'
    
    -- Перевіряємо, чи не є міліціонер останнім у ДТП
    DECLARE @AccidentID INT
    SELECT @AccidentID = ID_Accident FROM deleted
    
    DECLARE @PolicemanCount INT
    SELECT @PolicemanCount = COUNT(*) FROM Policeman WHERE ID_Accident = @AccidentID
    
    IF @PolicemanCount <= 1
    BEGIN
        RAISERROR('Не можна видалити останнього міліціонера у ДТП', 16, 1)
        ROLLBACK TRANSACTION
        RETURN
    END
    
    -- Якщо не останній, видаляємо
    DELETE FROM Policeman WHERE ID_Policeman IN (SELECT ID_Policeman FROM deleted)
    
    PRINT 'Міліціонера успішно видалено'
END;
GO
Пояснення до коду:
1.	AFTER INSERT тригер для таблиці Accident
Цей тригер спрацьовує після додавання нового запису про дорожньо-транспортну пригоду. Він виводить повідомлення про успішну вставку та відображає основні дані про додане ДТП (ідентифікатор, дата та місце). Такий тригер можна використовувати для фіксації подій або логування.
2.	INSTEAD OF INSERT тригер для таблиці Driver
Тригер перехоплює спробу вставки нового запису про водія та виконує додаткову перевірку:
o	довжина номеру водійського посвідчення не повинна перевищувати 10 символів;
o	прізвище, ім’я та по батькові — не довші за 50 символів кожне.
Якщо дані некоректні, тригер викликає помилку і скасовує транзакцію. Якщо перевірка пройдена — здійснюється вставка даних вручну. Такий підхід дозволяє реалізувати додаткові обмеження, не прописані явно в схемі таблиці.
3.	AFTER UPDATE тригер для таблиці Vehicle
Тригер виконується після оновлення запису про транспортний засіб. Він порівнює старі та нові значення номерного знаку (за допомогою псевдотаблиць inserted і deleted) та виводить відповідну інформацію. Це може бути корисно для відстеження змін або контролю за актуальністю даних.
4.	INSTEAD OF DELETE тригер для таблиці Policeman
Цей тригер перехоплює видалення міліціонера та перевіряє, чи не є він останнім, хто був прив’язаний до певного випадку ДТП. Якщо це останній міліціонер у події — видалення скасовується і генерується помилка. Інакше видалення відбувається. Така логіка дозволяє зберігати цілісність даних і запобігати втраті важливої інформації.

Загалом, використання DML-тригерів у цьому завданні демонструє, як можна забезпечити додаткову перевірку, аудит та контроль змін у базі даних, не покладаючись лише на звичайні обмеження або зовнішню логіку в додатках.



Завдання 4. DDL тригер з використанням різних комбінацій CREATE, DROP, ALTER.
У цьому завданні реалізую DDL-тригери (Data Definition Language triggers), які реагують на зміни в структурі бази даних, зокрема створення, зміну та видалення таблиць. Такі тригери застосовуються для аудиту, контролю змін та захисту структури бази даних. Вони створюються на рівні бази даних і дозволяють автоматично виконувати певні дії, коли відбуваються операції типу CREATE, ALTER, DROP.
Лістинг коду :

-- Завдання 4: DDL тригери

-- Тригер для відстеження створення таблиць
CREATE TRIGGER tr_Database_CreateTable
ON DATABASE
FOR CREATE_TABLE
AS
BEGIN
    PRINT 'Було створено нову таблицю'
    SELECT EVENTDATA().value('(/EVENT_INSTANCE/ObjectName)[1]', 'nvarchar(100)') AS 'Нова таблиця'
END;
GO

-- Тригер для відстеження змін у структурі таблиць
CREATE TRIGGER tr_Database_AlterTable
ON DATABASE
FOR ALTER_TABLE
AS
BEGIN
    PRINT 'Було змінено структуру таблиці'
    SELECT EVENTDATA().value('(/EVENT_INSTANCE/ObjectName)[1]', 'nvarchar(100)') AS 'Змінена таблиця'
END;
GO

-- Тригер для відстеження видалення таблиць
CREATE TRIGGER tr_Database_DropTable
ON DATABASE
FOR DROP_TABLE
AS
BEGIN
    PRINT 'Було видалено таблицю'
    SELECT EVENTDATA().value('(/EVENT_INSTANCE/ObjectName)[1]', 'nvarchar(100)') AS 'Видалена таблиця'
END;
GO
Пояснення до коду:
 У цьому завданні створено три DDL-тригери для відстеження змін у структурі бази даних на рівні створення, зміни та видалення таблиць.
1.	Тригер на створення таблиці активується кожного разу, коли в базі даних створюється нова таблиця. Він фіксує цю подію та виводить назву новоствореної таблиці. Це корисно для контролю за додаванням нових об'єктів у базу даних.
2.	Тригер на зміну таблиці реагує на зміни структури вже існуючих таблиць, наприклад, при додаванні або видаленні стовпців. При спрацюванні він повідомляє про зміну та вказує, яку саме таблицю було змінено. Такий тригер дозволяє відслідковувати модифікації схеми бази.
3.	Тригер на видалення таблиці спрацьовує, коли з бази видаляють таблицю. Він повідомляє про видалення та надає ім’я видаленої таблиці. Це дозволяє фіксувати потенційно критичні дії, пов’язані з втратою даних.
Усі тригери працюють на рівні бази даних, тому реагують на відповідні DDL-операції незалежно від того, до якої конкретної таблиці вони застосовуються. Для отримання інформації про подію використовується вбудована функція, що повертає XML-структуру з деталями, зокрема з назвою об'єкта, до якого було застосовано зміну.
Загалом, такі тригери використовуються для аудиту, моніторингу змін у структурі бази даних та забезпечення додаткового контролю за діями користувачів.
 


Завдання 5. LOGON тригер.
У цьому завданні реалізовано LOGON-тригер на рівні сервера, що дозволяє здійснювати аудит спроб входу користувачів до системи. LOGON-тригери є особливим типом тригерів у SQL Server, які запускаються під час підключення до сервера. Вони використовуються для підвищення безпеки, ведення журналів та контролю дій користувачів.
Окрім основного тригера входу, у роботі реалізовано два додаткових тригери для демонстрації:
•	автоматичне оновлення кількості постраждалих у ДТП,
•	перевірка унікальності номерів водійських посвідчень.

Лістинг коду :

-- Завдання 5: LOGON тригер

CREATE TRIGGER tr_Logon_Audit
ON ALL SERVER
FOR LOGON
AS
BEGIN
    DECLARE @LoginTime DATETIME = GETDATE();
    DECLARE @LoginName NVARCHAR(100) = ORIGINAL_LOGIN();

    BEGIN TRY
        INSERT INTO DAI_Database.dbo.AuditLog (EventType, LoginName, EventTime, Description)
        VALUES ('LOGON', @LoginName, @LoginTime, 'Успішний вхід у систему');
    END TRY
    BEGIN CATCH
        
    END CATCH
END;
GO

-- Додаткові тригери для демонстрації

-- Тригер для перевірки кількості постраждалих у ДТП
IF OBJECT_ID('tr_Accident_VictimCount', 'TR') IS NOT NULL
    DROP TRIGGER tr_Accident_VictimCount;
GO

CREATE TRIGGER tr_Accident_VictimCount
ON Victim
AFTER INSERT, DELETE
AS
BEGIN
    UPDATE a
    SET Victim_Count = (
        SELECT COUNT(*) 
        FROM Victim v 
        WHERE v.ID_Accident = a.ID_Accident
    )
    FROM Accident a
    WHERE a.ID_Accident IN (SELECT ID_Accident FROM inserted UNION SELECT ID_Accident FROM deleted)
END;
GO

-- Тригер для перевірки унікальності номерів посвідчень водіїв
IF OBJECT_ID('tr_Driver_LicenseUnique', 'TR') IS NOT NULL
    DROP TRIGGER tr_Driver_LicenseUnique;
GO

CREATE TRIGGER tr_Driver_LicenseUnique
ON Driver
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT License_Number 
        FROM Driver 
        GROUP BY License_Number 
        HAVING COUNT(*) > 1
    )
    BEGIN
        RAISERROR('Номер посвідчення водія повинен бути унікальним', 16, 1)
        ROLLBACK TRANSACTION
    END
END;
Пояснення до коду:
LOGON тригер (tr_Logon_Audit)
Цей тригер створюється на рівні всього сервера SQL Server і спрацьовує при кожному успішному вході користувача в систему.
•	Основна ідея: відслідковувати та фіксувати всі події входу користувачів у базу даних для аудиту безпеки.
•	Під час входу тригер отримує:
o	Поточний час входу (@LoginTime),
o	Ім’я користувача, який увійшов (@LoginName).
•	Далі тригер намагається записати цю інформацію в таблицю аудиту AuditLog, яка знаходиться у базі DAI_Database.
•	Запис містить тип події (LOGON), ім’я користувача, час події і короткий опис.
•	Використовується конструкція TRY...CATCH для безпечного виконання запису — у разі помилки, наприклад, якщо таблиця відсутня або база не доступна, тригер не викличе помилку і не завадить входу користувача.
Тригер для оновлення кількості постраждалих у ДТП (tr_Accident_VictimCount)
Цей тригер спрацьовує після вставки або видалення записів у таблиці Victim (потерпілих).
•	Його завдання — автоматично оновлювати поле Victim_Count у таблиці Accident, яке містить кількість постраждалих для кожного ДТП.
•	Після додавання або видалення постраждалих, він рахує, скільки осіб пов’язано з конкретною подією ДТП (ID_Accident) і оновлює відповідний запис у таблиці Accident.

Тригер для перевірки унікальності номерів посвідчень водіїв (tr_Driver_LicenseUnique)
Цей тригер виконується після вставки або оновлення записів у таблиці Driver.
•	Мета тригера — гарантувати, що номер водійського посвідчення (License_Number) у таблиці Driver є унікальним.
•	Якщо після операції вставки чи оновлення виявляється, що один і той самий номер посвідчення зустрічається більше одного разу, тригер:
o	Генерує помилку (RAISERROR) з відповідним повідомленням,
o	Відкочує всю транзакцію (ROLLBACK TRANSACTION), не дозволяючи зберегти дублікати.
Додатково
•	Перед створенням тригерів tr_Accident_VictimCount і tr_Driver_LicenseUnique виконується перевірка, чи вони вже існують, і у разі існування — їх видаляють командою DROP TRIGGER. Це дозволяє уникнути помилок під час повторного запуску скрипту.
Ці тригери забезпечують автоматизацію важливих перевірок і фіксацію подій у системі бази даних, що підвищує безпеку, цілісність і зручність адміністрування.

 

Завдання 6. Реалізація тригерів за тематикою лабораторної роботи DAI :
У цьому завданні було виконано розробку та впровадження тригерів для системи ДАІ відповідно до визначених бізнес-правил. Тригери забезпечують автоматичну перевірку коректності та цілісності даних при додаванні або оновленні записів у базі даних, що підвищує надійність роботи системи.



Лістинг коду :
4 тригери, які реалізують бізнес-правила системи ДАІ: 
--1. Тригер для перевірки унікальності номерного знака транспортного засобу
CREATE TRIGGER tr_Vehicle_LicensePlateUnique
ON Vehicle
INSTEAD OF INSERT
AS
BEGIN
    -- Перевірка на наявність дублікатів номерних знаків
    IF EXISTS (
        SELECT 1 
        FROM inserted i
        JOIN Vehicle v ON i.License_Plate = v.License_Plate
    )
    BEGIN
        RAISERROR('Транспортний засіб з таким номерним знаком вже існує', 16, 1)
        ROLLBACK TRANSACTION
        RETURN
    END
    
    -- Перевірка максимальної довжини номерного знака
    IF EXISTS (SELECT 1 FROM inserted WHERE LEN(License_Plate) > 10)
    BEGIN
        RAISERROR('Номерний знак не може бути довшим за 10 символів', 16, 1)
        ROLLBACK TRANSACTION
        RETURN
    END
    
    -- Якщо все в порядку, виконуємо вставку
    INSERT INTO Vehicle (ID_Accident, License_Plate, Model, Year)
    SELECT ID_Accident, License_Plate, Model, Year
    FROM inserted
    
    PRINT 'Транспортний засіб успішно додано'
END;
GO

--2. Тригер для перевірки телефону водія
CREATE TRIGGER tr_Driver_PhoneCheck
ON Driver
AFTER INSERT, UPDATE
AS
BEGIN
    -- Перевірка довжини телефону (мінімум 10 цифр)
    IF EXISTS (
        SELECT 1 
        FROM inserted 
        WHERE Phone IS NOT NULL AND LEN(REPLACE(REPLACE(REPLACE(REPLACE(Phone, ' ', ''), '-', ''), '(', ''), ')', '')) < 10
    )
    BEGIN
        RAISERROR('Номер телефону повинен містити щонайменше 10 цифр', 16, 1)
        ROLLBACK TRANSACTION
    END
END;
GO

--3. Тригер для перевірки наявності міліціонера для ДТП
CREATE TRIGGER tr_Accident_PolicemanCheck
ON Accident
AFTER INSERT, UPDATE
AS
BEGIN
    -- Перевірка, чи для кожного нового ДТП є хоча б один міліціонер
    IF EXISTS (
        SELECT i.ID_Accident
        FROM inserted i
        LEFT JOIN Policeman p ON i.ID_Accident = p.ID_Accident
        WHERE p.ID_Policeman IS NULL
    )
    BEGIN
        RAISERROR('Кожне ДТП повинно мати хоча б одного призначеного міліціонера', 16, 1)
        ROLLBACK TRANSACTION
    END
END;
GO

--4. Тригер для перевірки унікальності номерів паспортів
CREATE TRIGGER tr_Person_PassportUnique
ON Victim
AFTER INSERT, UPDATE
AS
BEGIN
    -- Перевірка унікальності номерів паспортів серед постраждалих
    IF EXISTS (
        SELECT Passport_Number
        FROM Victim
        WHERE Passport_Number IN (SELECT Passport_Number FROM inserted)
        GROUP BY Passport_Number
        HAVING COUNT(*) > 1
    )
    BEGIN
        RAISERROR('Номер паспорта повинен бути унікальним серед постраждалих', 16, 1)
        ROLLBACK TRANSACTION
        RETURN
    END
    
    -- Перевірка унікальності номерів паспортів серед пішоходів
    IF EXISTS (
        SELECT 1
        FROM inserted i
        JOIN Pedestrian p ON i.Passport_Number = p.Passport_Number
    )
    BEGIN
        RAISERROR('Цей номер паспорта вже використовується пішоходом', 16, 1)
        ROLLBACK TRANSACTION
    END
END;
GO
Пояснення до коду:
1.	Тригер tr_Vehicle_LicensePlateUnique
Цей тригер працює замість стандартної вставки (INSTEAD OF INSERT) у таблицю транспортних засобів (Vehicle). Він перевіряє унікальність номерного знака транспортного засобу, забороняючи додавання дублікатів. Також тригер контролює довжину номерного знака, не допускаючи значення довжиною більше 10 символів. Якщо перевірки не проходять — операція вставки скасовується із відповідним повідомленням про помилку.
2.	Тригер tr_Driver_PhoneCheck
Цей тригер спрацьовує після вставки або оновлення записів у таблиці водіїв (Driver). Він перевіряє коректність номера телефону, зокрема, що кількість цифр у телефоні не менша за 10. Якщо це правило порушується, транзакція скасовується, а користувач отримує повідомлення про помилку.
3.	Тригер tr_Accident_PolicemanCheck
Тригер контролює, щоб для кожного ДТП (запису у таблиці Accident) був призначений хоча б один міліціонер (таблиця Policeman). Якщо для ДТП відсутній відповідальний міліціонер, транзакція скасовується, що запобігає збереженню некоректних або неповних даних.
4.	Тригер tr_Person_PassportUnique
Цей тригер відповідає за унікальність номерів паспортів серед постраждалих (Victim). Він перевіряє, щоб номер паспорта не повторювався серед постраждалих та не співпадав із номером паспорта пішоходів (Pedestrian). При виявленні порушень транзакція скасовується із повідомленням про помилку.
Таким чином, реалізовані тригери забезпечують автоматичний контроль за важливими бізнес-правилами системи ДАІ на рівні бази даних, підвищуючи надійність, консистентність та якість збережених даних.
№	Опис тригера мовою TSQL	Умови запуску / Його тип та опис
1	CREATE TRIGGER tr_Vehicle_LicensePlateUnique ON Vehicle INSTEAD OF INSERT AS ...
	Тип: INSTEAD OF INSERT 
Умови запуску: При спробі додати новий транспортний засіб 
Опис: Перевіряє унікальність номерного знака (макс. 10 символів) та блокує вставку при виявленні дублікатів

2	CREATE TRIGGER tr_Driver_PhoneCheck ON Driver AFTER INSERT, UPDATE AS ...
	Тип: AFTER INSERT, UPDATE 
Умови запуску: Після додавання або зміни даних водія 
Опис: Перевіряє довжину номера телефону (мінімум 10 цифр), скасовує операцію при невідповідності

3	CREATE TRIGGER tr_Accident_PolicemanCheck ON Accident AFTER INSERT, UPDATE AS ...
	Тип: AFTER INSERT, UPDATE 
Умови запуску: Після створення або зміни запису про ДТП 
Опис: Перевіряє наявність хоча б одного міліціонера для ДТП, блокує операцію при порушенні правила

4	CREATE TRIGGER tr_Person_PassportUnique ON Victim AFTER INSERT, UPDATE AS ...
	Тип: AFTER INSERT, UPDATE 
Умови запуску: Після додавання або зміни даних постраждалого 
Опис: Забезпечує унікальність номерів паспортів серед постраждалих та пішоходів
Таблиця 1. 
  


Висновки:
У ході виконання роботи я ознайомилася з поняттям тригерів у системі керування базами даних Microsoft SQL Server, їхнім призначенням, типами та особливостями використання. Я дізналася, що тригери є спеціальними об’єктами бази даних, які автоматично виконуються у відповідь на події модифікації даних (INSERT, UPDATE або DELETE), і відіграють важливу роль у забезпеченні цілісності даних.
Я навчилася створювати, змінювати та видаляти тригери за допомогою мови T-SQL, а також використовувати їх для реалізації бізнес-правил і обмежень, що не можуть бути безпосередньо виражені засобами стандартних обмежень цілісності. Практичні приклади дозволили мені краще зрозуміти, як тригери впливають на поведінку бази даних і як їх можна ефективно застосовувати для контролю за змінами в таблицях.
Загалом, виконання цієї роботи поглибило мої знання про механізми забезпечення цілісності даних у Microsoft SQL Server та надало практичні навички роботи з тригерами.



Посилання на конспект: https://docs.google.com/document/d/1cQ80CNWDVrDLPALv9pUK2ATEX58BABgg/edit?usp=drive_link&ouid=106130475242017779182&rtpof=true&sd=true
